name: Radar_System_Commander

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  patrol:
    runs-on: ubuntu-latest
    steps:
      - name: 檢出代碼
        uses: actions/checkout@v3

      - name: 設置 Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: 安裝組件
        run: pip install requests pandas

      - name: 派遣偵查兵
        env:
          TRADE_SYMBOL: ${{ secrets.TRADE_SYMBOL }}
        run: python radar_executor.py

      - name: 啟動項接收並轉發異常
        if: always() # 確保偵查完畢後一定執行檢查
        run: |
          # 檢查偵查兵有沒有留下報告
          if [ -f "radar_alert.log" ]; then
            MESSAGE=$(cat radar_alert.log)
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
              -d "chat_id=${{ secrets.TG_CHAT_ID }}" \
              -d "text=$MESSAGE" \
              -d "parse_mode=HTML"
            # 發送完畢後刪除，避免下一輪重複
            rm radar_alert.log
          fi
