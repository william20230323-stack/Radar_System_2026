name: V1_V2_Long_Range_Radar

on:
  schedule:
    # å„ªåŒ–ï¼šåˆ†æ•£æ™‚é–“é»ï¼Œé¿å…å›ºå®šé–“éš”
    - cron: '8,23,38,53 * * * *'    # æ¯15åˆ†é˜ä½†åç§»8åˆ†é˜
    - cron: '14,29,44,59 * * * *'   # ç¬¬äºŒçµ„åç§»14åˆ†é˜
  workflow_dispatch:        # æ‰‹å‹•é»ç«
  push:
    branches: [ main ]     # ä»£ç¢¼æ›´æ–°æ™‚ä¹Ÿè§¸ç™¼

jobs:
  radar-mission:
    runs-on: ubuntu-latest
    # é—œéµï¼šè¨­ç½®è¶…æ™‚ï¼Œé¿å…ç„¡é™é‹è¡Œ
    timeout-minutes: 12
    
    steps:
      - name: 1. éš¨æ©Ÿå»¶é²å•Ÿå‹• (é˜²åµæ¸¬)
        run: sleep $((RANDOM % 60))  # éš¨æ©Ÿç­‰å¾…0-60ç§’
        
      - name: 2. æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v3
        with:
          fetch-depth: 1  # ç¯€çœæµé‡

      - name: 3. åˆå§‹åŒ– Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: 4. å®‰è£çµ„ä»¶
        run: |
          pip install --upgrade pip
          pip install websocket-client requests
          echo "âœ… çµ„ä»¶å®‰è£å®Œæˆ"

      - name: 5. ç™¼é€å•Ÿå‹•é€šçŸ¥åˆ° Telegram
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          python3 -c "
          import requests, os, datetime
          
          token = os.getenv('TG_TOKEN')
          chat_id = os.getenv('TG_CHAT_ID')
          
          if token and chat_id:
              now = datetime.datetime.now().strftime('%m/%d %H:%M:%S')
              message = f'''âœ… V1/V2é›·é”ç³»çµ±å•Ÿå‹•æˆåŠŸ
              
              â° æ™‚é–“: {now}
              ğŸ”„ å·¥ä½œæµ: ${{ github.workflow }}
              ğŸ“ é‹è¡ŒID: ${{ github.run_id }}
              
              ğŸš€ é–‹å§‹åŸ·è¡Œæƒæä»»å‹™...'''
              
              url = f'https://api.telegram.org/bot{token}/sendMessage'
              data = {
                  'chat_id': chat_id,
                  'text': message,
                  'parse_mode': 'HTML'
              }
              
              try:
                  response = requests.post(url, json=data, timeout=10)
                  if response.status_code == 200:
                      print('ğŸ“¤ Telegramé€šçŸ¥ç™¼é€æˆåŠŸ')
                  else:
                      print(f'âš ï¸ é€šçŸ¥ç™¼é€å¤±æ•—: {response.status_code}')
              except Exception as e:
                  print(f'âš ï¸ ç™¼é€éŒ¯èª¤: {e}')
          else:
              print('âš ï¸ ç¼ºå°‘TG_TOKENæˆ–TG_CHAT_IDç’°å¢ƒè®Šé‡')
          "

      - name: 6. åŸ·è¡Œå„ªåŒ–ç‰ˆé›·é”ç³»çµ±
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          TRADE_SYMBOL: ${{ secrets.TRADE_SYMBOL }}
        run: |
          # å‰µå»ºæ™ºèƒ½é›·é”æ§åˆ¶å™¨
          cat > smart_radar.py << 'EOF'
          import os
          import time
          import random
          import requests
          import sys
          from datetime import datetime
          
          # ===== Telegram é€šçŸ¥å‡½æ•¸ =====
          def telegram_notify(message):
              """ç™¼é€Telegramé€šçŸ¥"""
              token = os.getenv('TG_TOKEN')
              chat_id = os.getenv('TG_CHAT_ID')
              
              if not token or not chat_id:
                  print("âš ï¸ ç¼ºå°‘Telegramé…ç½®")
                  return False
              
              try:
                  url = f"https://api.telegram.org/bot{token}/sendMessage"
                  payload = {
                      "chat_id": chat_id,
                      "text": message,
                      "parse_mode": "HTML"
                  }
                  response = requests.post(url, json=payload, timeout=5)
                  return response.status_code == 200
              except:
                  return False
          
          # ===== é›·é”æƒæå‡½æ•¸ =====
          def radar_scan(scan_id):
              """åŸ·è¡Œå–®æ¬¡é›·é”æƒæ"""
              timestamp = datetime.now().strftime("%H:%M:%S")
              print(f"[{timestamp}] ğŸ” æƒæ #{scan_id} é€²è¡Œä¸­...")
              
              # é€™è£¡æ”¾ç½®ä½ çš„å¯¦éš›é›·é”é‚è¼¯
              # ä¾‹å¦‚ï¼šwebsocketé€£æ¥ã€æ•¸æ“šç²å–ã€åˆ†æç­‰
              
              # æ¨¡æ“¬æƒæå·¥ä½œ
              time.sleep(random.randint(2, 5))  # éš¨æ©Ÿå·¥ä½œæ™‚é–“
              
              # å¶çˆ¾ç™¼é€ç‹€æ…‹æ›´æ–°ï¼ˆæ¯10æ¬¡æƒæä¸€æ¬¡ï¼‰
              if scan_id % 10 == 0:
                  telegram_notify(f"ğŸ“Š é›·é”ç‹€æ…‹å ±å‘Š\nå·²å®Œæˆ {scan_id} æ¬¡æƒæ")
              
              return True
          
          # ===== ä¸»æ§åˆ¶å¾ªç’° =====
          def main_control_loop():
              """ä¸»æ§åˆ¶å¾ªç’° - é˜²å°é–å„ªåŒ–ç‰ˆ"""
              print("ğŸš€ V1/V2 æ™ºèƒ½é›·é”ç³»çµ±å•Ÿå‹•")
              
              scan_count = 0
              start_time = time.time()
              
              while True:
                  scan_count += 1
                  
                  # 1. åŸ·è¡Œæƒæ
                  success = radar_scan(scan_count)
                  
                  if not success:
                      telegram_notify("âš ï¸ é›·é”æƒæå¤±æ•—ï¼Œç­‰å¾…æ¢å¾©...")
                      time.sleep(60)  # å¤±æ•—å¾Œç­‰å¾…1åˆ†é˜
                      continue
                  
                  # 2. æ™ºèƒ½ç­‰å¾…ç­–ç•¥ï¼ˆé—œéµï¼šé˜²å°é–ï¼‰
                  # åŸºç¤ç­‰å¾…æ™‚é–“ï¼š13-17åˆ†é˜éš¨æ©Ÿ
                  base_wait = random.randint(13, 17) * 60  # ç§’
                  
                  # æ ¹æ“šé‹è¡Œæ™‚é–“èª¿æ•´ï¼ˆé•·æ™‚é–“é‹è¡Œå¾Œå¢åŠ é–“éš”ï¼‰
                  run_hours = (time.time() - start_time) / 3600
                  if run_hours > 6:  # é‹è¡Œè¶…é6å°æ™‚
                      base_wait += random.randint(60, 180)  # å¢åŠ 1-3åˆ†é˜
                  
                  # è½‰æ›ç‚ºåˆ†é˜é¡¯ç¤º
                  wait_minutes = base_wait // 60
                  wait_seconds = base_wait % 60
                  
                  print(f"â³ ä¸‹æ¬¡æƒæ: {wait_minutes}åˆ†{wait_seconds}ç§’å¾Œ")
                  
                  # 3. åˆ†æ‰¹ç­‰å¾…ï¼ˆé¿å…å–®æ¬¡é•·æ™‚é–“sleepï¼‰
                  for i in range(base_wait):
                      if i % 300 == 0 and i > 0:  # æ¯5åˆ†é˜æ‰“å°ä¸€æ¬¡
                          print(f"  ç­‰å¾…ä¸­... {i//60}åˆ†é˜")
                      time.sleep(1)
          
          # ===== ç¨‹åºå…¥å£ =====
          if __name__ == "__main__":
              try:
                  # å•Ÿå‹•é€šçŸ¥
                  telegram_notify("ğŸŸ¢ <b>V1/V2é›·é”ç³»çµ±å•Ÿå‹•</b>\né–‹å§‹24/7ç›£æ§æœå‹™")
                  
                  # é€²å…¥ä¸»å¾ªç’°
                  main_control_loop()
                  
              except KeyboardInterrupt:
                  telegram_notify("ğŸŸ¡ <b>é›·é”ç³»çµ±æ‰‹å‹•åœæ­¢</b>")
                  print("\nğŸ‘‹ ç¨‹å¼çµæŸ")
                  
              except Exception as e:
                  error_msg = f"ğŸ”´ <b>é›·é”ç³»çµ±ç•°å¸¸</b>\néŒ¯èª¤: {str(e)}"
                  telegram_notify(error_msg)
                  print(f"âŒ éŒ¯èª¤ç™¼ç”Ÿ: {e}")
                  sys.exit(1)
          EOF
          
          echo "ğŸš€ é–‹å§‹åŸ·è¡Œæ™ºèƒ½é›·é”ç³»çµ±..."
          python3 smart_radar.py

      - name: 7. å·¥ä½œæµç‹€æ…‹å ±å‘Š
        if: always()
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          python3 -c "
          import os, requests, datetime
          
          token = os.getenv('TG_TOKEN')
          chat_id = os.getenv('TG_CHAT_ID')
          
          if token and chat_id:
              status = '${{ job.status }}'
              run_time = '${{ job.container.service_time }}'
              now = datetime.datetime.now().strftime('%m/%d %H:%M')
              
              status_emoji = {
                  'success': 'âœ…',
                  'failure': 'âŒ',
                  'cancelled': 'âš ï¸'
              }.get(status, 'ğŸ”¸')
              
              message = f'''{status_emoji} <b>å·¥ä½œæµå®Œæˆå ±å‘Š</b>
              
              ç‹€æ…‹: {status}
              å·¥ä½œæµ: ${{ github.workflow }}
              é‹è¡ŒID: ${{ github.run_id }}
              æ™‚é–“: {now}
              
              ğŸ“Š æœ¬æ¬¡åŸ·è¡ŒçµæŸ'''
              
              url = f'https://api.telegram.org/bot{token}/sendMessage'
              requests.post(url, json={
                  'chat_id': chat_id,
                  'text': message,
                  'parse_mode': 'HTML'
              })
          "
