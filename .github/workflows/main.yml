import websocket, json, time, requests, os
from config import RADAR_TOKEN, RADAR_CHAT_ID, SYMBOL

class UnifiedRadar:
    def __init__(self):
        self.prices = []
        self.reset_metrics()
        self.end_time = time.time() + 250 # é‹è¡Œ 4 åˆ†é˜

    def reset_metrics(self):
        self.start_time = time.time()
        self.open_price = 0.0
        self.buy_vol, self.sell_vol = 0.0, 0.0
        self.is_alerted = False

    def send_msg(self, text):
        url = f"https://api.telegram.org/bot{RADAR_TOKEN}/sendMessage"
        try:
            requests.post(url, json={"chat_id": RADAR_CHAT_ID, "text": text, "parse_mode": "Markdown"}, timeout=5)
            self.is_alerted = True
        except: pass

    def on_message(self, ws, message):
        if time.time() > self.end_time:
            ws.close()
            return
        
        d = json.loads(message)
        p, v = float(d['p']), float(d['p']) * float(d['q'])
        
        if self.open_price == 0: self.open_price = p
        
        if d['m']: self.sell_vol += v # ä¸»å‹•æ‹‹å”®
        else: self.buy_vol += v       # ä¸»å‹•æƒè²¨

        elapsed = time.time() - self.start_time
        
        # æ¯åˆ†é˜çµç®—ä¸€æ¬¡èƒŒé›¢é‚è¼¯
        if 55 <= elapsed < 60 and not self.is_alerted:
            ratio = self.buy_vol / self.sell_vol if self.sell_vol > 0 else 1.0
            chg = (p - self.open_price) / self.open_price * 100
            
            # V1: éš±æ€§æ”¯æ’/æ‹‰é«˜å‡ºè²¨ (æ¨¡çµ„ F/E)
            if chg < -0.15 and ratio > 1.8:
                self.send_msg(f"âš ï¸ *ã€æ­¦å™¨åº«ï¼šéš±æ€§æ”¯æ’ã€‘*\næ¨™çš„ï¼š`{SYMBOL}`\nğŸ“‰ åƒ¹æ ¼ä¸‹è·Œä½†è²·ç›¤å¼·å‹ï¼\nğŸ”¥ ç‡ƒæ–™æ¯”ï¼š`{ratio:.2f}`")
            elif chg > 0.15 and ratio < 0.6:
                self.send_msg(f"ğŸš¨ *ã€æ­¦å™¨åº«ï¼šæ‹‰é«˜å‡ºè²¨ã€‘*\næ¨™çš„ï¼š`{SYMBOL}`\nğŸ“ˆ åƒ¹æ ¼ä¸Šå‡ä½†è³£å£“æ²‰é‡ï¼\nğŸ’¸ ç‡ƒæ–™æ¯”ï¼š`{ratio:.2f}`")
            
            # V2: åƒ¹æ ¼èˆ‡å‹•èƒ½èƒŒé›¢ (ç•¶å‰åƒ¹ vs å‰ä¸€åˆ†é˜åƒ¹)
            if len(self.prices) > 0:
                if p > self.prices[-1] and ratio < 0.6:
                    self.send_msg(f"ğŸ›¡ï¸ *ã€æ­¦å™¨åº«ï¼šé ‚éƒ¨å‹•èƒ½èƒŒé›¢ã€‘*\næ¨™çš„ï¼š`{SYMBOL}`\nğŸ“ˆ åƒ¹å‡é‡ç¸®ï¼Œå°å¿ƒå›æ’¤ï¼")

        if elapsed >= 60:
            self.prices.append(p)
            self.reset_metrics()

if __name__ == "__main__":
    print(f"ğŸ“¡ {SYMBOL} é‡åƒ¹/å‹•èƒ½é›™é‡é›·é”æ›è¼‰ä¸­...")
    radar = UnifiedRadar()
    ws = websocket.WebSocketApp(f"wss://fstream.binance.com/ws/{SYMBOL.lower()}@trade", on_message=radar.on_message)
    ws.run_forever()
