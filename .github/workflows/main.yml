name: V1_V2_Long_Range_Radar

on:
  schedule:
    # åˆ†æ•£åŸ·è¡Œæ™‚é–“ï¼Œé¿å…å›ºå®šé–“éš”
    - cron: '9,24,39,54 * * * *'    # æ¯å°æ™‚çš„9ã€24ã€39ã€54åˆ†åŸ·è¡Œ
    - cron: '16,31,46,1 * * * *'    # æ¯å°æ™‚çš„16ã€31ã€46ã€1åˆ†åŸ·è¡Œ
  workflow_dispatch:                 # æ‰‹å‹•è§¸ç™¼
  push:
    branches: [ main ]              # ä»£ç¢¼æ›´æ–°æ™‚è§¸ç™¼

jobs:
  radar-mission:
    runs-on: ubuntu-latest
    # è¨­ç½®è¶…æ™‚ï¼Œé¿å…ç„¡é™é‹è¡Œ
    timeout-minutes: 14
    
    steps:
      # æ­¥é©Ÿ1ï¼šéš¨æ©Ÿå»¶é²å•Ÿå‹•
      - name: 1. éš¨æ©Ÿå»¶é²å•Ÿå‹•
        run: |
          echo "ğŸ• éš¨æ©Ÿå»¶é²å•Ÿå‹•ä¸­..."
          sleep $((RANDOM % 45 + 15))
          echo "âœ… å»¶é²çµæŸï¼Œé–‹å§‹åŸ·è¡Œ"
        
      # æ­¥é©Ÿ2ï¼šæª¢å‡ºä»£ç¢¼
      - name: 2. æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
        
      # æ­¥é©Ÿ3ï¼šåˆå§‹åŒ– Python
      - name: 3. åˆå§‹åŒ– Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'
        
      # æ­¥é©Ÿ4ï¼šå®‰è£çµ„ä»¶
      - name: 4. å®‰è£çµ„ä»¶
        run: |
          echo "ğŸ“¦ å®‰è£å¿…è¦çµ„ä»¶..."
          pip install --upgrade pip
          pip install websocket-client requests
          echo "âœ… çµ„ä»¶å®‰è£å®Œæˆ"
        
      # æ­¥é©Ÿ5ï¼šç™¼é€å•Ÿå‹•é€šçŸ¥
      - name: 5. ç™¼é€å•Ÿå‹•é€šçŸ¥åˆ° Telegram
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          python3 -c "
          import requests, os, datetime
          
          token = os.getenv('TG_TOKEN')
          chat_id = os.getenv('TG_CHAT_ID')
          
          if token and chat_id:
              now = datetime.datetime.now()
              time_str = now.strftime('%m/%d %H:%M:%S')
              
              message = f'''ğŸš€ <b>V1/V2é›·é”ç³»çµ±å•Ÿå‹•æˆåŠŸ</b>
              
â° æ™‚é–“: {time_str}
ğŸ”„ å·¥ä½œæµ: ${{ github.workflow }}
ğŸ”¢ é‹è¡ŒID: ${{ github.run_id }}
              
ğŸ’¡ ç³»çµ±é–‹å§‹åŸ·è¡Œæƒæä»»å‹™'''
              
              url = f'https://api.telegram.org/bot{token}/sendMessage'
              data = {
                  'chat_id': chat_id,
                  'text': message,
                  'parse_mode': 'HTML'
              }
              
              try:
                  response = requests.post(url, json=data, timeout=10)
                  if response.status_code == 200:
                      print('âœ… Telegramé€šçŸ¥ç™¼é€æˆåŠŸ')
                  else:
                      print(f'âš ï¸ é€šçŸ¥ç™¼é€å¤±æ•—: {response.status_code}')
              except Exception as e:
                  print(f'âš ï¸ ç™¼é€éŒ¯èª¤: {e}')
          else:
              print('âš ï¸ ç¼ºå°‘TG_TOKENæˆ–TG_CHAT_ID')
          "
        
      # æ­¥é©Ÿ6ï¼šåŸ·è¡Œæ™ºèƒ½é›·é”ç³»çµ±
      - name: 6. åŸ·è¡Œæ™ºèƒ½é›·é”ç³»çµ±
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          TRADE_SYMBOL: ${{ secrets.TRADE_SYMBOL }}
        run: |
          echo "ğŸš€ å‰µå»ºæ™ºèƒ½é›·é”ç³»çµ±..."
          
          # å‰µå»ºPythonè…³æœ¬
          cat > smart_radar.py << 'EOF'
          import os
          import time
          import random
          import requests
          import sys
          from datetime import datetime
          
          def telegram_notify(message):
              token = os.getenv('TG_TOKEN')
              chat_id = os.getenv('TG_CHAT_ID')
              
              if not token or not chat_id:
                  return False
              
              try:
                  url = f"https://api.telegram.org/bot{token}/sendMessage"
                  payload = {
                      "chat_id": chat_id,
                      "text": message,
                      "parse_mode": "HTML"
                  }
                  response = requests.post(url, json=payload, timeout=5)
                  return response.status_code == 200
              except:
                  return False
          
          def radar_scan(scan_id):
              timestamp = datetime.now().strftime("%H:%M:%S")
              print(f"[{timestamp}] ğŸ” æƒæ #{scan_id}")
              
              # é€™è£¡æ›¿æ›ç‚ºä½ çš„å¯¦éš›é‚è¼¯
              time.sleep(random.randint(2, 5))
              
              # æ¨¡æ“¬90%æˆåŠŸç‡
              if random.random() < 0.9:
                  return True
              else:
                  return False
          
          def main_control_loop():
              print("=" * 50)
              print("ğŸš€ V1/V2 æ™ºèƒ½é›·é”ç³»çµ±å•Ÿå‹•")
              print("=" * 50)
              
              scan_count = 0
              error_count = 0
              start_time = time.time()
              
              while True:
                  scan_count += 1
                  
                  # åŸ·è¡Œæƒæ
                  success = radar_scan(scan_count)
                  
                  if not success:
                      error_count += 1
                  
                  # æ¯5æ¬¡æƒæç™¼é€å ±å‘Š
                  if scan_count % 5 == 0:
                      run_hours = (time.time() - start_time) / 3600
                      report = f'''ğŸ“Š <b>é›·é”ç‹€æ…‹å ±å‘Š</b>
                      
æƒææ¬¡æ•¸: {scan_count}
é‹è¡Œæ™‚é–“: {run_hours:.1f}å°æ™‚
éŒ¯èª¤æ¬¡æ•¸: {error_count}
ç‹€æ…‹: {'æ­£å¸¸' if error_count < 3 else 'æ³¨æ„'}'''
                      telegram_notify(report)
                  
                  # æ™ºèƒ½ç­‰å¾… (13-17åˆ†é˜)
                  wait_seconds = random.randint(13 * 60, 17 * 60)
                  wait_minutes = wait_seconds // 60
                  
                  print(f"â³ ä¸‹æ¬¡æƒæ: {wait_minutes}åˆ†é˜å¾Œ")
                  print("-" * 30)
                  
                  # ç­‰å¾…
                  for i in range(wait_seconds):
                      if i % 300 == 0 and i > 0:
                          print(f"  ç­‰å¾…ä¸­... {i//60}åˆ†é˜")
                      time.sleep(1)
          
          if __name__ == "__main__":
              max_retries = 3
              retry_count = 0
              
              # å•Ÿå‹•é€šçŸ¥
              telegram_notify("ğŸš€ <b>V1/V2é›·é”ç³»çµ±å•Ÿå‹•</b>")
              
              while retry_count < max_retries:
                  try:
                      if retry_count > 0:
                          print(f"ğŸ”„ ç¬¬ {retry_count} æ¬¡é‡è©¦")
                          telegram_notify(f"ğŸ”„ <b>ç¬¬{retry_count}æ¬¡é‡è©¦</b>")
                      
                      main_control_loop()
                      
                  except KeyboardInterrupt:
                      telegram_notify("â¹ï¸ <b>æ‰‹å‹•åœæ­¢</b>")
                      print("ğŸ‘‹ ç¨‹å¼çµæŸ")
                      break
                      
                  except Exception as e:
                      retry_count += 1
                      print(f"âŒ éŒ¯èª¤: {e}")
                      
                      if retry_count < max_retries:
                          telegram_notify(f"ğŸ”„ <b>éŒ¯èª¤é‡è©¦ {retry_count}/{max_retries}</b>")
                          time.sleep(30)
                      else:
                          telegram_notify(f"ğŸ’¥ <b>ç³»çµ±å¤±æ•—</b>\néŒ¯èª¤: {type(e).__name__}")
                          sys.exit(1)
          EOF
          
          echo "âœ… è…³æœ¬å‰µå»ºå®Œæˆ"
          echo "ğŸš€ é–‹å§‹åŸ·è¡Œ..."
          python3 smart_radar.py
        
      # æ­¥é©Ÿ7ï¼šå®Œæˆé€šçŸ¥
      - name: 7. å·¥ä½œæµå®Œæˆé€šçŸ¥
        if: always()
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          python3 -c "
          import os, requests
          
          token = os.getenv('TG_TOKEN')
          chat_id = os.getenv('TG_CHAT_ID')
          
          if token and chat_id:
              status = '${{ job.status }}'
              
              icons = {
                  'success': 'âœ…',
                  'failure': 'âŒ',
                  'cancelled': 'âš ï¸'
              }
              
              icon = icons.get(status, 'ğŸ”¸')
              
              message = f'''{icon} <b>å·¥ä½œæµå®Œæˆ</b>
              
ç‹€æ…‹: {status}
å·¥ä½œæµ: ${{ github.workflow }}
é‹è¡ŒID: ${{ github.run_id }}'''
              
              url = f'https://api.telegram.org/bot{token}/sendMessage'
              requests.post(url, json={
                  'chat_id': chat_id,
                  'text': message,
                  'parse_mode': 'HTML'
              })
          "
